<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisión en Tiempo Real - Sistema de Supervisión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-ring {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.5;
            }
        }

        .live-indicator {
            animation: live-blink 1.5s ease-in-out infinite;
        }

        @keyframes live-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        @media (max-width: 640px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
        }

        .video-card {
            position: relative;
            background: #1a1a1a;
            border-radius: 1rem;
            overflow: hidden;
            aspect-ratio: 16/9;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 1rem;
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="{
    sidebarOpen: false,
    activeStreams: 0,
    totalViewers: 0,
    recordingActive: true,
    selectedStream: null,
    streams: [],
    activities: [],
    events: [],
    loading: true,
    userProfile: null,
    recordingStreams: new Set(),
    showProfileMenu: false,
    
    // Helper: Detectar tipo de plataforma de reunión
    getMeetingPlatform(meetingUrl) {
        if (!meetingUrl) return null;
        const url = meetingUrl.toLowerCase();
        if (url.includes('jitsi') || url.includes('meet.jit.si') || url.includes('8x8.vc')) {
            return 'jitsi';
        } else if (url.includes('meet.google.com') || url.includes('google.com/meet')) {
            return 'google-meet';
        } else if (url.includes('zoom.us') || url.includes('zoom.com')) {
            return 'zoom';
        } else if (url.includes('teams.microsoft.com') || url.includes('teams.live.com')) {
            return 'teams';
        } else if (url.includes('webex.com')) {
            return 'webex';
        } else if (url.includes('gotomeeting.com')) {
            return 'gotomeeting';
        }
        return 'generic';
    },
    
    // Helper: Obtener URL formateada para iframe según plataforma
    getMeetingIframeUrl(meetingUrl) {
        if (!meetingUrl) return null;
        const platform = this.getMeetingPlatform(meetingUrl);
        
        switch(platform) {
            case 'jitsi':
                // Jitsi: agregar parámetro para API externa si no está presente
                if (!meetingUrl.includes('jitsi_meet_external_api_enabled')) {
                    const separator = meetingUrl.includes('?') ? '&' : '?';
                    return meetingUrl + separator + 'jitsi_meet_external_api_enabled=true';
                }
                return meetingUrl;
            case 'google-meet':
                // Google Meet: usar URL directa (no soporta iframe embebido)
                return null; // Retornar null para abrir en nueva ventana
            case 'zoom':
                // Zoom: algunos enlaces permiten iframe, otros no
                return meetingUrl;
            case 'teams':
                // Teams: usar URL directa
                return null;
            default:
                // Para otras plataformas, intentar usar el URL directamente
                return meetingUrl;
        }
    },
    
    // Helper: Verificar si la plataforma soporta iframe embebido
    supportsIframe(meetingUrl) {
        if (!meetingUrl) return false;
        const platform = this.getMeetingPlatform(meetingUrl);
        // Solo Jitsi y algunas configuraciones de Zoom soportan iframe embebido
        return platform === 'jitsi' || platform === 'generic';
    },
    
    // Helper: Obtener nombre de la plataforma
    getPlatformName(meetingUrl) {
        if (!meetingUrl) return 'Sin enlace';
        const platform = this.getMeetingPlatform(meetingUrl);
        const names = {
            'jitsi': 'Jitsi Meet',
            'google-meet': 'Google Meet',
            'zoom': 'Zoom',
            'teams': 'Microsoft Teams',
            'webex': 'Webex',
            'gotomeeting': 'GoToMeeting',
            'generic': 'Reunión en línea'
        };
        return names[platform] || 'Reunión en línea';
    },
    
    async captureScreenshot(streamId) {
        try {
            const stream = this.streams.find(s => s.id === streamId);
            if (!stream || !stream.eventData || !stream.eventData.meeting_url) {
                this.showToast('No hay video disponible para capturar', 'warning');
                return;
            }
            
            // Crear evidencia desde la captura
            const evidenceData = {
                event_id: streamId,
                title: `Captura - ${stream.eventData.title}`,
                description: `Captura de pantalla de transmisión en vivo`,
                evidence_type: 'foto',
                location: stream.eventData.location || 'Transmisión en vivo',
                tags: ['captura', 'transmision', 'tiempo-real']
            };
            
            // Nota: Para captura real necesitaríamos usar canvas API
            // Por ahora, creamos una evidencia sin archivo
            const response = await api.createEvidence(evidenceData, []);
            
            if (response.success) {
                this.showToast('Captura guardada exitosamente', 'success');
                await this.loadData(); // Recargar actividad
            } else {
                throw new Error(response.message || 'Error al guardar captura');
            }
        } catch (error) {
            console.error('Error capturing screenshot:', error);
            this.showToast('Error al capturar: ' + error.message, 'error');
        }
    },
    
    toggleRecording(streamId) {
        if (this.recordingStreams.has(streamId)) {
            this.recordingStreams.delete(streamId);
            this.showToast('Grabación detenida', 'info');
        } else {
            this.recordingStreams.add(streamId);
            this.showToast('Grabación iniciada', 'success');
        }
    },
    
    isRecording(streamId) {
        return this.recordingStreams.has(streamId);
    },
    
    shareStream(streamId) {
        const stream = this.streams.find(s => s.id === streamId);
        if (!stream || !stream.eventData || !stream.eventData.meeting_url) {
            this.showToast('No hay transmisión para compartir', 'warning');
            return;
        }
        
        // Copiar URL al portapapeles
        navigator.clipboard.writeText(stream.eventData.meeting_url).then(() => {
            this.showToast('Enlace copiado al portapapeles', 'success');
        }).catch(() => {
            // Fallback para navegadores antiguos
            const textArea = document.createElement('textarea');
            textArea.value = stream.eventData.meeting_url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            this.showToast('Enlace copiado al portapapeles', 'success');
        });
    },
    
    showToast(message, type = 'info', duration = 4000) {
        // Sistema de toasts simple - evitar template literals anidados
        const toast = document.createElement('div');
        
        // Determinar clases CSS
        let borderClass = 'border-blue-500';
        let iconClass = 'fa-info-circle text-blue-500';
        
        if (type === 'success') {
            borderClass = 'border-green-500';
            iconClass = 'fa-check-circle text-green-500';
        } else if (type === 'error') {
            borderClass = 'border-red-500';
            iconClass = 'fa-exclamation-circle text-red-500';
        } else if (type === 'warning') {
            borderClass = 'border-yellow-500';
            iconClass = 'fa-exclamation-triangle text-yellow-500';
        }
        
        toast.className = 'fixed top-20 right-6 z-[9999] bg-white rounded-lg shadow-2xl border-l-4 p-4 min-w-[320px] ' + borderClass;
        
        // Construir HTML usando createElement para evitar problemas de comillas
        const container = document.createElement('div');
        container.className = 'flex items-start space-x-3';
        
        const icon = document.createElement('i');
        icon.className = 'fas text-xl ' + iconClass;
        container.appendChild(icon);
        
        const messageP = document.createElement('p');
        messageP.className = 'text-sm font-semibold text-gray-800 flex-1';
        messageP.textContent = message;
        container.appendChild(messageP);
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'text-gray-400 hover:text-gray-600';
        closeBtn.onclick = function() { toast.remove(); };
        const closeIcon = document.createElement('i');
        closeIcon.className = 'fas fa-times text-sm';
        closeBtn.appendChild(closeIcon);
        container.appendChild(closeBtn);
        
        toast.appendChild(container);
        
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    },
    
    async init() {
        if (!api.getToken()) {
            window.location.href = '/login.html';
            return;
        }
        
        await this.loadData();
        // Actualizar cada 30 segundos
        setInterval(() => this.loadData(), 30000);
    },
    
    async loadData() {
        try {
            // Cargar perfil
            const profileRes = await api.getProfile();
            if (profileRes.success) {
                this.userProfile = profileRes.data;
            }
            
            // Cargar eventos en curso
            const eventsRes = await api.getEvents();
            if (eventsRes.success) {
                // Filtrar solo eventos en curso
                this.events = (eventsRes.data || []).filter(e => e.status === 'en_curso');
                this.streams = this.events.map((event, index) => {
                    const hasMeeting = !!event.meeting_url;
                    const platform = hasMeeting ? this.getMeetingPlatform(event.meeting_url) : null;
                    const iframeUrl = hasMeeting ? this.getMeetingIframeUrl(event.meeting_url) : null;
                    const supportsEmbed = hasMeeting ? this.supportsIframe(event.meeting_url) : false;
                    
                    return {
                        id: event.id,
                        name: event.location || `Sala ${index + 1}`,
                        viewers: event.current_participants || 0,
                        status: hasMeeting ? 'live' : 'offline',
                        event: `${event.title} #${event.id}`,
                        quality: 'HD',
                        hasVideo: hasMeeting,
                        hasIframe: supportsEmbed,
                        iframeUrl: iframeUrl,
                        platform: platform,
                        platformName: hasMeeting ? this.getPlatformName(event.meeting_url) : null,
                        eventData: event
                    };
                });
                // Contar solo transmisiones con enlace de reunión activo
                this.activeStreams = this.streams.filter(s => s.hasVideo).length;
                this.totalViewers = this.streams.filter(s => s.hasVideo).reduce((sum, s) => sum + s.viewers, 0);
            }
            
            // Cargar evidencias recientes como actividad
            const evidencesRes = await api.getRecentEvidences(5);
            if (evidencesRes.success) {
                this.activities = (evidencesRes.data || []).map(ev => ({
                    type: 'record',
                    user: 'Sistema',
                    location: ev.location || 'Sin ubicación',
                    time: this.formatTime(ev.created_at),
                    evidence: ev
                }));
            }
        } catch (error) {
            console.error('Error loading data:', error);
            if (error.message.includes('401')) {
                window.location.href = '/login.html';
            }
        } finally {
            this.loading = false;
        }
    },
    
    formatTime(dateString) {
        if (!dateString) return 'Hace un momento';
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        
        if (minutes < 1) return 'Hace un momento';
        if (minutes < 60) return `Hace ${minutes} min`;
        return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
    }
}">

    <!-- Mobile Overlay -->
    <div x-show="sidebarOpen" 
         @click="sidebarOpen = false"
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"></div>

    <!-- Sidebar -->
    <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'" 
            class="fixed left-0 top-0 h-full bg-white shadow-xl transition-all duration-300 z-50 w-64 lg:w-64">
        <div class="flex flex-col h-full">
            <div class="p-4 lg:p-6 gradient-bg">
                <div class="flex items-center justify-between">
                    <div class="text-white">
                        <h1 class="text-lg lg:text-xl font-bold">SuperVision</h1>
                        <p class="text-xs text-purple-200">Sistema de Monitoreo</p>
                    </div>
                    <button @click="sidebarOpen = !sidebarOpen" class="text-white hover:bg-white/20 p-2 rounded-lg lg:hidden">
                        <i class="fas fa-times"></i>
                    </button>
                    <button @click="sidebarOpen = !sidebarOpen" class="text-white hover:bg-white/20 p-2 rounded-lg hidden lg:block">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>

            <nav class="flex-1 p-2 lg:p-4 space-y-1 lg:space-y-2 overflow-y-auto">
                <a href="index.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-chart-line w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Dashboard</span>
                </a>

                <a href="registro-evidencias.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-camera w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Registro de Evidencias</span>
                </a>

                <a href="listados.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-list-alt w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Listados y Registros</span>
                </a>

                <a href="supervision-tiempo-real.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 text-white">
                    <i class="fas fa-eye w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Supervisión en Vivo</span>
                </a>

                <a href="eventos-capacitacion.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-calendar-check w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Eventos y Capacitación</span>
                </a>

                <hr class="my-2 lg:my-4">

                <a href="configuracion.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-cog w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Configuración</span>
                </a>

                <a href="ayuda.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-question-circle w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Ayuda</span>
                </a>
            </nav>

            <div class="p-3 lg:p-4 border-t">
                <div class="flex items-center space-x-2 lg:space-x-3 mb-3">
                    <img :src="userProfile ? `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfile.full_name || 'User')}&background=667eea&color=fff` : 'https://ui-avatars.com/api/?name=User&background=667eea&color=fff'"
                         class="w-8 h-8 lg:w-10 lg:h-10 rounded-full flex-shrink-0" alt="User">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs lg:text-sm font-semibold text-gray-700 truncate" x-text="userProfile ? userProfile.full_name : 'Usuario'"></p>
                        <p class="text-[10px] lg:text-xs text-gray-500 truncate" x-text="userProfile ? (userProfile.role || 'Usuario').charAt(0).toUpperCase() + (userProfile.role || 'Usuario').slice(1) : 'Usuario'"></p>
                    </div>
                </div>
                <button @click="api.logout()" class="w-full flex items-center justify-center space-x-2 px-3 lg:px-4 py-2 lg:py-2.5 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl font-medium transition-colors text-sm lg:text-base">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-64 transition-all duration-300">

        <!-- Top Bar -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between p-4 lg:p-6 gap-4">
                <div class="flex items-center justify-between w-full lg:w-auto">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3">
                            <button @click="sidebarOpen = true" class="lg:hidden text-gray-600 hover:bg-gray-100 p-2 rounded-lg">
                                <i class="fas fa-bars text-xl"></i>
                            </button>
                            <div class="min-w-0 flex-1">
                                <h2 class="text-lg lg:text-2xl font-bold text-gray-800 flex flex-wrap items-center gap-2">
                                    <span>Supervisión en Tiempo Real</span>
                                    <span class="flex items-center">
                                        <span class="live-indicator w-2 h-2 lg:w-3 lg:h-3 bg-red-500 rounded-full mr-1 lg:mr-2"></span>
                                        <span class="text-xs lg:text-sm font-medium text-red-500">EN VIVO</span>
                                    </span>
                                </h2>
                                <p class="text-gray-500 text-xs lg:text-sm">Monitoreo activo de <span x-text="activeStreams"></span> transmisión<span x-show="activeStreams !== 1">es</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-2 lg:space-x-4 flex-wrap lg:flex-nowrap">
                    <div class="flex items-center space-x-2 px-3 lg:px-4 py-2 bg-green-100 text-green-700 rounded-xl text-sm">
                        <i class="fas fa-circle text-xs live-indicator"></i>
                        <span class="font-semibold text-xs lg:text-sm" x-text="`${totalViewers} espectadores`"></span>
                    </div>

                    <button @click="recordingActive = !recordingActive"
                            :class="recordingActive ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-400 hover:bg-gray-500'"
                            class="px-3 lg:px-4 py-2 text-white rounded-xl transition-all font-medium text-xs lg:text-sm whitespace-nowrap">
                        <i class="fas fa-record-vinyl mr-1 lg:mr-2"></i>
                        <span x-text="recordingActive ? 'Grabando' : 'Pausado'"></span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 lg:p-6">

            <!-- Live Stats - Mejorado -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6 mb-6 lg:mb-8">
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl shadow-lg p-4 lg:p-6 border border-green-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <p class="text-green-600 text-xs lg:text-sm font-semibold mb-1 lg:mb-2 uppercase tracking-wide">Transmisiones Activas</p>
                            <p class="text-3xl lg:text-4xl font-bold text-gray-800 mb-1 lg:mb-2" x-text="activeStreams"></p>
                            <div class="flex items-center space-x-2">
                                <span :class="activeStreams > 0 ? 'live-indicator' : ''" 
                                      class="w-2 h-2 lg:w-2.5 lg:h-2.5 rounded-full"
                                      :class="activeStreams > 0 ? 'bg-green-500' : 'bg-gray-400'"></span>
                                <span class="text-[10px] lg:text-xs font-medium" 
                                      :class="activeStreams > 0 ? 'text-green-600' : 'text-gray-500'"
                                      x-text="activeStreams > 0 ? 'Todas operativas' : 'Sin transmisiones'"></span>
                            </div>
                        </div>
                        <div class="p-3 lg:p-5 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl lg:rounded-2xl shadow-lg flex-shrink-0">
                            <i class="fas fa-broadcast-tower text-white text-2xl lg:text-3xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl shadow-lg p-4 lg:p-6 border border-blue-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <p class="text-blue-600 text-xs lg:text-sm font-semibold mb-1 lg:mb-2 uppercase tracking-wide">Total Espectadores</p>
                            <p class="text-3xl lg:text-4xl font-bold text-gray-800 mb-1 lg:mb-2" x-text="totalViewers"></p>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-users text-blue-500 text-[10px] lg:text-xs"></i>
                                <span class="text-[10px] lg:text-xs font-medium text-blue-600 truncate" 
                                      x-text="`${activeStreams} transmisión${activeStreams !== 1 ? 'es' : ''}`"></span>
                            </div>
                        </div>
                        <div class="p-3 lg:p-5 bg-gradient-to-br from-blue-400 to-cyan-500 rounded-xl lg:rounded-2xl shadow-lg flex-shrink-0">
                            <i class="fas fa-users text-white text-2xl lg:text-3xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-lg p-4 lg:p-6 border border-purple-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <p class="text-purple-600 text-xs lg:text-sm font-semibold mb-1 lg:mb-2 uppercase tracking-wide">Grabación</p>
                            <p class="text-xl lg:text-2xl font-bold text-gray-800 mb-1 lg:mb-2" x-text="recordingActive ? 'En curso' : 'Pausado'"></p>
                            <div class="flex items-center space-x-2">
                                <span :class="recordingActive ? 'live-indicator' : ''" 
                                      class="w-2 h-2 lg:w-2.5 lg:h-2.5 rounded-full"
                                      :class="recordingActive ? 'bg-red-500' : 'bg-gray-400'"></span>
                                <span class="text-[10px] lg:text-xs font-medium truncate" 
                                      :class="recordingActive ? 'text-red-600' : 'text-gray-500'"
                                      x-text="recordingActive ? 'Grabando activamente' : 'Grabación pausada'"></span>
                            </div>
                        </div>
                        <div class="p-3 lg:p-5 bg-gradient-to-br from-purple-400 to-pink-500 rounded-xl lg:rounded-2xl shadow-lg flex-shrink-0">
                            <i class="fas fa-record-vinyl text-white text-2xl lg:text-3xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">

                <!-- Video Grid -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-xl p-4 lg:p-6 mb-4 lg:mb-6 border border-gray-100">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4 lg:mb-6">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-1">Transmisiones en Vivo</h3>
                                <p class="text-xs lg:text-sm text-gray-500">Monitoreo en tiempo real de eventos activos</p>
                            </div>
                            <div class="flex items-center space-x-2 flex-wrap">
                                <button class="px-3 lg:px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all hover:scale-105 text-sm" title="Vista de cuadrícula">
                                    <i class="fas fa-th-large"></i>
                                </button>
                                <button class="px-3 lg:px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all hover:scale-105 text-sm" title="Vista de lista">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>

                        <div x-show="loading" class="text-center py-12 lg:py-16">
                            <i class="fas fa-spinner fa-spin text-purple-600 text-3xl lg:text-4xl mb-3 lg:mb-4"></i>
                            <p class="text-gray-600 font-semibold mb-2 text-sm lg:text-base">Cargando transmisiones...</p>
                        </div>
                        <div x-show="!loading && activeStreams === 0" class="text-center py-12 lg:py-16">
                            <i class="fas fa-video-slash text-gray-300 text-4xl lg:text-6xl mb-3 lg:mb-4"></i>
                            <p class="text-gray-600 font-semibold mb-2 text-sm lg:text-base">No hay transmisiones activas</p>
                            <p class="text-xs lg:text-sm text-gray-500 mb-3 lg:mb-4">Los eventos en curso con enlace de reunión aparecerán aquí</p>
                            <div class="mt-4 lg:mt-6 p-3 lg:p-4 bg-blue-50 rounded-xl max-w-md mx-auto">
                                <p class="text-xs lg:text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-1 lg:mr-2"></i>
                                    Para ver transmisiones, asegúrate de que los eventos en curso tengan un enlace de reunión configurado.
                                </p>
                            </div>
                        </div>
                        <div x-show="!loading && activeStreams > 0" class="video-grid">
                            <template x-for="stream in streams.filter(s => s.hasVideo)" :key="stream.id">
                                <div class="video-card group cursor-pointer" @click="selectedStream = stream">
                                    <!-- Video embebido si la plataforma lo soporta -->
                                    <template x-if="stream.hasIframe && stream.iframeUrl">
                                        <iframe 
                                            :src="stream.iframeUrl"
                                            class="absolute inset-0 w-full h-full"
                                            allow="camera; microphone; fullscreen; autoplay"
                                            frameborder="0"
                                            style="min-height: 100%;">
                                        </iframe>
                                    </template>
                                    <!-- Botón para abrir en nueva ventana si no soporta iframe pero tiene enlace -->
                                    <template x-if="stream.hasVideo && !stream.hasIframe">
                                        <div class="absolute inset-0 bg-gradient-to-br from-blue-700 to-blue-900 flex items-center justify-center cursor-pointer" 
                                             @click.stop="window.open(stream.eventData.meeting_url, '_blank')">
                                            <div class="text-center p-4 lg:p-6">
                                                <i class="fas fa-external-link-alt text-4xl lg:text-6xl text-white mb-3 lg:mb-4"></i>
                                                <p class="text-white font-semibold text-base lg:text-lg mb-2" x-text="stream.platformName || 'Reunión en línea'"></p>
                                                <p class="text-blue-200 text-xs lg:text-sm mb-3 lg:mb-4" x-text="stream.name"></p>
                                                <button class="px-4 lg:px-6 py-2 lg:py-3 bg-white text-blue-700 rounded-xl font-semibold hover:bg-blue-50 transition-colors text-sm">
                                                    <i class="fas fa-external-link-alt mr-1 lg:mr-2"></i>
                                                    <span class="hidden sm:inline">Abrir en nueva ventana</span><span class="sm:hidden">Abrir</span>
                                                </button>
                                                <p class="text-blue-300 text-[10px] lg:text-xs mt-2 lg:mt-3">Esta plataforma no permite visualización embebida</p>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Live indicator - solo mostrar si tiene enlace activo -->
                                    <div x-show="stream.hasVideo" class="absolute top-2 lg:top-3 left-2 lg:left-3 px-2 lg:px-3 py-1 bg-red-500 text-white rounded-lg text-[10px] lg:text-xs font-bold flex items-center">
                                        <span class="live-indicator w-1.5 h-1.5 lg:w-2 lg:h-2 bg-white rounded-full mr-1 lg:mr-2"></span>
                                        EN VIVO
                                    </div>
                                    <!-- Badge de plataforma -->
                                    <div x-show="stream.platformName" class="absolute top-2 lg:top-3 right-2 lg:right-3 px-1.5 lg:px-2 py-0.5 lg:py-1 bg-black/70 text-white rounded text-[10px] lg:text-xs font-semibold" x-text="stream.platformName"></div>
                                    <!-- Quality badge (solo si no hay plataforma) -->
                                    <div x-show="!stream.platformName && stream.hasVideo" class="absolute top-2 lg:top-3 right-2 lg:right-3 px-1.5 lg:px-2 py-0.5 lg:py-1 bg-black/70 text-white rounded text-[10px] lg:text-xs font-semibold" x-text="stream.quality"></div>

                                    <!-- Overlay -->
                                    <div class="video-overlay opacity-0 group-hover:opacity-100 transition-opacity">
                                        <div class="flex items-center justify-between gap-2">
                                            <div class="flex-1 min-w-0">
                                                <h4 class="text-white font-semibold mb-1 text-sm lg:text-base truncate" x-text="stream.name"></h4>
                                                <p class="text-gray-300 text-xs lg:text-sm truncate" x-text="stream.event"></p>
                                            </div>
                                            <div class="flex items-center space-x-1 lg:space-x-2 text-white flex-shrink-0">
                                                <i class="fas fa-eye text-xs lg:text-sm"></i>
                                                <span class="text-xs lg:text-sm font-medium" x-text="stream.viewers"></span>
                                            </div>
                                        </div>
                                        <div class="mt-2 lg:mt-3 flex items-center space-x-1 lg:space-x-2 flex-wrap">
                                            <a :href="`eventos-capacitacion.html#event-${stream.id}`" class="p-1.5 lg:p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" title="Ver detalles">
                                                <i class="fas fa-expand text-white text-xs lg:text-sm"></i>
                                            </a>
                                            <button @click.stop="shareStream(stream.id)" class="p-1.5 lg:p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" title="Compartir enlace">
                                                <i class="fas fa-share-alt text-white text-xs lg:text-sm"></i>
                                            </button>
                                            <button @click.stop="captureScreenshot(stream.id)" class="p-1.5 lg:p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" title="Capturar pantalla">
                                                <i class="fas fa-camera text-white text-xs lg:text-sm"></i>
                                            </button>
                                            <button @click.stop="toggleRecording(stream.id)" 
                                                    :class="isRecording(stream.id) ? 'bg-red-500/50 hover:bg-red-500/70' : 'bg-white/20 hover:bg-white/30'"
                                                    class="p-1.5 lg:p-2 rounded-lg transition-colors" title="Grabar">
                                                <i :class="isRecording(stream.id) ? 'fas fa-stop' : 'fas fa-record-vinyl'" class="text-white text-xs lg:text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Stream Controls -->
                    <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl shadow-xl p-4 lg:p-6 border border-gray-100">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4 lg:mb-6">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-1">Controles de Transmisión</h3>
                                <p class="text-xs lg:text-sm text-gray-500">Gestiona las transmisiones activas</p>
                            </div>
                            <div x-show="selectedStream" class="flex items-center space-x-2 px-3 py-1 bg-purple-100 rounded-lg">
                                <span class="live-indicator w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                                <span class="text-xs font-semibold text-purple-700 truncate" x-text="selectedStream ? selectedStream.name : ''"></span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                            <button @click="selectedStream && captureScreenshot(selectedStream.id)" 
                                    :disabled="!selectedStream"
                                    :class="selectedStream ? 'hover:border-purple-500 hover:bg-purple-50 hover:shadow-lg hover:scale-105' : 'opacity-50 cursor-not-allowed'"
                                    class="p-3 lg:p-5 border-2 border-gray-200 rounded-xl lg:rounded-2xl transition-all duration-300 text-center group bg-white">
                                <div class="w-10 h-10 lg:w-14 lg:h-14 mx-auto bg-gradient-to-br from-purple-100 to-purple-200 group-hover:from-purple-200 group-hover:to-purple-300 rounded-xl lg:rounded-2xl flex items-center justify-center mb-2 lg:mb-3 shadow-md group-hover:shadow-lg transition-all">
                                    <i class="fas fa-camera text-purple-600 text-base lg:text-xl"></i>
                                </div>
                                <p class="font-bold text-gray-800 text-xs lg:text-sm mb-1">Capturar</p>
                                <p class="text-[10px] lg:text-xs text-gray-500">Tomar foto</p>
                            </button>

                            <button @click="selectedStream && toggleRecording(selectedStream.id)"
                                    :disabled="!selectedStream"
                                    :class="selectedStream && isRecording(selectedStream.id) ? 'border-red-500 bg-red-50 shadow-lg' : selectedStream ? 'hover:border-red-500 hover:bg-red-50 hover:shadow-lg hover:scale-105' : 'opacity-50 cursor-not-allowed'"
                                    class="p-3 lg:p-5 border-2 border-gray-200 rounded-xl lg:rounded-2xl transition-all duration-300 text-center group bg-white">
                                <div :class="selectedStream && isRecording(selectedStream.id) ? 'bg-gradient-to-br from-red-200 to-red-300 shadow-lg' : 'bg-gradient-to-br from-red-100 to-red-200 group-hover:from-red-200 group-hover:to-red-300'" 
                                     class="w-10 h-10 lg:w-14 lg:h-14 mx-auto rounded-xl lg:rounded-2xl flex items-center justify-center mb-2 lg:mb-3 shadow-md group-hover:shadow-lg transition-all">
                                    <i :class="selectedStream && isRecording(selectedStream.id) ? 'fas fa-stop' : 'fas fa-record-vinyl'" 
                                       class="text-red-600 text-base lg:text-xl"></i>
                                </div>
                                <p class="font-bold text-gray-800 text-xs lg:text-sm mb-1" x-text="selectedStream && isRecording(selectedStream.id) ? 'Detener' : 'Grabar'"></p>
                                <p class="text-[10px] lg:text-xs text-gray-500" x-text="selectedStream && isRecording(selectedStream.id) ? 'Pausar grabación' : 'Iniciar/Pausar'"></p>
                            </button>

                            <button @click="selectedStream && shareStream(selectedStream.id)"
                                    :disabled="!selectedStream"
                                    :class="selectedStream ? 'hover:border-blue-500 hover:bg-blue-50 hover:shadow-lg hover:scale-105' : 'opacity-50 cursor-not-allowed'"
                                    class="p-3 lg:p-5 border-2 border-gray-200 rounded-xl lg:rounded-2xl transition-all duration-300 text-center group bg-white">
                                <div class="w-10 h-10 lg:w-14 lg:h-14 mx-auto bg-gradient-to-br from-blue-100 to-blue-200 group-hover:from-blue-200 group-hover:to-blue-300 rounded-xl lg:rounded-2xl flex items-center justify-center mb-2 lg:mb-3 shadow-md group-hover:shadow-lg transition-all">
                                    <i class="fas fa-share-alt text-blue-600 text-base lg:text-xl"></i>
                                </div>
                                <p class="font-bold text-gray-800 text-xs lg:text-sm mb-1">Compartir</p>
                                <p class="text-[10px] lg:text-xs text-gray-500">Enviar enlace</p>
                            </button>

                            <button @click="selectedStream && selectedStream.eventData && selectedStream.eventData.meeting_url && window.open(selectedStream.eventData.meeting_url, '_blank')"
                                    :disabled="!selectedStream || !selectedStream.eventData || !selectedStream.eventData.meeting_url"
                                    :class="selectedStream && selectedStream.eventData && selectedStream.eventData.meeting_url ? 'hover:border-green-500 hover:bg-green-50 hover:shadow-lg hover:scale-105' : 'opacity-50 cursor-not-allowed'"
                                    class="p-3 lg:p-5 border-2 border-gray-200 rounded-xl lg:rounded-2xl transition-all duration-300 text-center group bg-white">
                                <div class="w-10 h-10 lg:w-14 lg:h-14 mx-auto bg-gradient-to-br from-green-100 to-green-200 group-hover:from-green-200 group-hover:to-green-300 rounded-xl lg:rounded-2xl flex items-center justify-center mb-2 lg:mb-3 shadow-md group-hover:shadow-lg transition-all">
                                    <i class="fas fa-external-link-alt text-green-600 text-base lg:text-xl"></i>
                                </div>
                                <p class="font-bold text-gray-800 text-xs lg:text-sm mb-1 truncate" x-text="selectedStream && selectedStream.platformName ? 'Abrir ' + selectedStream.platformName : 'Abrir'"></p>
                                <p class="text-[10px] lg:text-xs text-gray-500">En nueva ventana</p>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">

                    <!-- Activity Feed -->
                    <div class="bg-white rounded-2xl shadow-xl p-4 lg:p-6 border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-base lg:text-lg font-bold text-gray-800 flex items-center">
                                <i class="fas fa-history text-purple-600 mr-2 text-sm lg:text-base"></i>
                                <span class="hidden sm:inline">Actividad Reciente</span><span class="sm:hidden">Actividad</span>
                            </h3>
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-lg text-[10px] lg:text-xs font-semibold" x-text="activities.length"></span>
                        </div>

                        <div x-show="loading" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-purple-600 text-2xl"></i>
                        </div>
                        <div x-show="!loading" class="activity-timeline relative pl-8 lg:pl-12 space-y-3 lg:space-y-4">
                            <template x-for="(activity, index) in activities" :key="index">
                                <div class="timeline-item relative">
                                    <div class="bg-gray-50 rounded-lg p-2 lg:p-3">
                                        <div class="flex items-start space-x-2">
                                            <div class="flex-shrink-0 w-6 h-6 lg:w-8 lg:h-8 rounded-full flex items-center justify-center"
                                                 :class="{
                                                     'bg-green-100': activity.type === 'join',
                                                     'bg-red-100': activity.type === 'leave',
                                                     'bg-blue-100': activity.type === 'record',
                                                     'bg-orange-100': activity.type === 'alert'
                                                 }">
                                                <i class="text-xs lg:text-sm"
                                                   :class="{
                                                       'fas fa-user-plus text-green-600': activity.type === 'join',
                                                       'fas fa-user-minus text-red-600': activity.type === 'leave',
                                                       'fas fa-record-vinyl text-blue-600': activity.type === 'record',
                                                       'fas fa-exclamation-triangle text-orange-600': activity.type === 'alert'
                                                   }"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-xs lg:text-sm font-semibold text-gray-800 truncate" x-text="activity.user"></p>
                                                <p class="text-[10px] lg:text-xs text-gray-500 truncate" x-text="activity.location"></p>
                                                <p class="text-[10px] lg:text-xs text-gray-400 mt-1" x-text="activity.time"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="activities.length === 0" class="text-center py-6 lg:py-8">
                                <i class="fas fa-inbox text-gray-300 text-xl lg:text-2xl mb-2"></i>
                                <p class="text-xs text-gray-500">No hay actividad reciente</p>
                            </div>
                        </div>

                        <button class="w-full mt-3 lg:mt-4 py-2 text-purple-600 hover:bg-purple-50 rounded-xl transition-colors font-medium text-xs lg:text-sm">
                            Ver todo el historial
                        </button>
                    </div>

                    <!-- Stream Info Card -->
                    <div class="bg-gradient-to-br from-purple-500 via-purple-600 to-indigo-600 rounded-2xl shadow-xl p-4 lg:p-6 text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full -ml-12 -mb-12"></div>
                        <div class="relative z-10">
                            <h3 class="text-base lg:text-lg font-bold mb-3 lg:mb-4 flex items-center">
                                <i class="fas fa-broadcast-tower mr-2"></i>
                                Estado en Vivo
                            </h3>
                            
                            <div class="space-y-3 lg:space-y-4">
                                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 lg:p-4 border border-white/20">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs lg:text-sm font-medium text-purple-100">Transmisiones</span>
                                        <span class="text-xl lg:text-2xl font-bold" x-text="activeStreams"></span>
                                    </div>
                                    <div class="flex items-center space-x-2 text-[10px] lg:text-xs text-purple-200">
                                        <span :class="activeStreams > 0 ? 'live-indicator' : ''" 
                                              class="w-1.5 h-1.5 lg:w-2 lg:h-2 rounded-full"
                                              :class="activeStreams > 0 ? 'bg-green-300' : 'bg-gray-400'"></span>
                                        <span x-text="activeStreams > 0 ? 'En vivo' : 'Sin transmisiones'"></span>
                                    </div>
                                </div>
                                
                                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 lg:p-4 border border-white/20">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs lg:text-sm font-medium text-purple-100">Espectadores</span>
                                        <span class="text-xl lg:text-2xl font-bold" x-text="totalViewers"></span>
                                    </div>
                                    <div class="text-[10px] lg:text-xs text-purple-200">
                                        <i class="fas fa-users mr-1"></i>
                                        <span x-text="`En ${activeStreams} transmisión${activeStreams !== 1 ? 'es' : ''}`"></span>
                                    </div>
                                </div>
                                
                                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 lg:p-4 border border-white/20">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs lg:text-sm font-medium text-purple-100">Actividades</span>
                                        <span class="text-xl lg:text-2xl font-bold" x-text="activities.length"></span>
                                    </div>
                                    <div class="text-[10px] lg:text-xs text-purple-200">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>Última hora</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 lg:mt-6 pt-3 lg:pt-4 border-t border-white/20">
                                <a href="eventos-capacitacion.html" class="flex items-center justify-between text-xs lg:text-sm font-medium hover:text-purple-200 transition-colors">
                                    <span>Gestionar eventos</span>
                                    <i class="fas fa-arrow-right text-xs lg:text-sm"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

        </main>

    </div>

</body>
</html>
