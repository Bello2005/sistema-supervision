<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listados y Registros - Sistema de Supervisión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .table-row-hover:hover {
            background-color: #f9fafb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
    </style>
    <script>
        function listadosData() {
            return {
                sidebarOpen: false,
                activeTab: 'all',
                searchQuery: '',
                selectedItems: [],
                showExportModal: false,
                showViewModal: false,
                showEditModal: false,
                showShareModal: false,
                selectedEvidence: null,
                editFormData: {
                    title: '',
                    description: '',
                    location: '',
                    tags: []
                },
                newFiles: [],
                filesToDelete: [],
                saving: false,
                shareLink: '',
                records: [],
                stats: { total: 0, photos: 0, videos: 0, attendance: 0 },
                loading: true,
                userProfile: null,
                toasts: [],
                sortBy: 'date',
                sortOrder: 'desc',
                currentPage: 1,
                itemsPerPage: 10,
                showFilterModal: false,
                showSortModal: false,
                showProfileMenu: false,
                
                async init() {
                    if (!api.getToken()) {
                        window.location.href = '/login.html';
                        return;
                    }
                    
                    await this.loadData();
                    
                    // Verificar si hay hash para mostrar evidencia específica
                    const hash = window.location.hash;
                    if (hash && hash.startsWith('#evidence-')) {
                        const evidenceId = parseInt(hash.replace('#evidence-', ''));
                        if (evidenceId) {
                            await this.viewEvidence(evidenceId);
                        }
                    }
                },
                
                async loadData() {
                    try {
                        this.loading = true;
                        
                        // Cargar perfil
                        const profileRes = await api.getProfile();
                        if (profileRes.success) {
                            this.userProfile = profileRes.data;
                        } else {
                            console.warn('No se pudo cargar el perfil:', profileRes.message);
                        }
                        
                        // Cargar todas las evidencias desde el backend
                        const evidencesRes = await api.getEvidences();
                        if (evidencesRes.success && evidencesRes.data) {
                            this.records = (evidencesRes.data || []).map(ev => ({
                                id: ev.id,
                                type: this.getEvidenceTypeLabel(ev.evidence_type),
                                event: ev.event_id ? `Evento #${ev.event_id}` : 'Sin evento',
                                eventTitle: ev.event_title || null,
                                items: parseInt(ev.file_count) || 0,
                                date: this.formatDate(ev.created_at || ev.captured_at),
                                status: 'Completo',
                                category: this.getCategoryFromType(ev.evidence_type),
                                evidence: ev,
                                uploadedBy: ev.uploaded_by_name || 'Sistema',
                                title: ev.title || 'Sin título'
                            }));
                            
                            // Ordenar por fecha más reciente primero
                            this.records.sort((a, b) => {
                                const dateA = new Date(a.evidence.created_at || a.evidence.captured_at);
                                const dateB = new Date(b.evidence.created_at || b.evidence.captured_at);
                                return dateB.getTime() - dateA.getTime();
                            });
                        } else {
                            console.error('Error loading evidences:', evidencesRes.message || 'Error desconocido');
                            this.records = [];
                            this.showToast('Error al cargar evidencias: ' + (evidencesRes.message || 'Error desconocido'), 'error');
                        }
                        
                        // Cargar estadísticas desde el backend
                        const statsRes = await api.getEvidencesStats();
                        if (statsRes.success && statsRes.data) {
                            const statsData = statsRes.data;
                            this.stats = {
                                total: parseInt(statsData.total_evidences || statsData.total || 0),
                                photos: parseInt(statsData.fotos || 0),
                                videos: parseInt(statsData.videos || 0),
                                attendance: parseInt(statsData.documentos || 0)
                            };
                        } else {
                            console.error('Error loading stats:', statsRes.message || 'Error desconocido');
                            this.stats = { total: 0, photos: 0, videos: 0, attendance: 0 };
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                        this.showToast('Error al cargar datos: ' + error.message, 'error');
                        if (error.message.includes('401') || error.message.includes('Authentication')) {
                            window.location.href = '/login.html';
                        }
                    } finally {
                        this.loading = false;
                    }
                },
                
                get filteredRecords() {
                    let filtered = this.records;

                    if (this.activeTab !== 'all') {
                        filtered = filtered.filter(r => r.category === this.activeTab);
                    }

                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(r =>
                            r.type.toLowerCase().includes(query) ||
                            r.event.toLowerCase().includes(query) ||
                            (r.title && r.title.toLowerCase().includes(query)) ||
                            (r.evidence?.location && r.evidence.location.toLowerCase().includes(query))
                        );
                    }

                    return filtered;
                },
                
                getEvidenceTypeLabel(type) {
                    const labels = {
                        'foto': 'Registro Fotográfico',
                        'video': 'Registro de Video',
                        'documento': 'Registro de Documento',
                        'audio': 'Registro de Audio'
                    };
                    return labels[type] || 'Registro';
                },
                
                getCategoryFromType(type) {
                    const categories = {
                        'foto': 'photos',
                        'video': 'videos',
                        'documento': 'attendance',
                        'audio': 'attendance'
                    };
                    return categories[type] || 'all';
                },
                
                formatDate(dateString) {
                    if (!dateString) return 'Sin fecha';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) {
                            return 'Sin fecha';
                        }
                        return date.toLocaleDateString('es-ES', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric'
                        });
                    } catch (error) {
                        return 'Sin fecha';
                    }
                },

                toggleSelection(id) {
                    const index = this.selectedItems.indexOf(id);
                    if (index > -1) {
                        this.selectedItems.splice(index, 1);
                    } else {
                        this.selectedItems.push(id);
                    }
                },

                selectAll() {
                    if (this.selectedItems.length === this.sortedRecords.length && this.sortedRecords.length > 0) {
                        this.selectedItems = [];
                    } else {
                        this.selectedItems = this.sortedRecords.map(r => r.id);
                    }
                },
                
                showToast(message, type = 'info', duration = 4000) {
                    if (!this.toasts || !Array.isArray(this.toasts)) {
                        this.toasts = [];
                    }
                    
                    // Generate unique ID with timestamp and random number
                    const toastId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    const toast = {
                        id: toastId,
                        message: String(message || ''),
                        type: type || 'info',
                        show: true
                    };
                    this.toasts.push(toast);
                    
                    setTimeout(() => {
                        if (toast) {
                            toast.show = false;
                            setTimeout(() => {
                                if (this.toasts && Array.isArray(this.toasts)) {
                                    const index = this.toasts.findIndex(t => t && t.id === toast.id);
                                    if (index > -1) {
                                        this.toasts.splice(index, 1);
                                    }
                                }
                            }, 300);
                        }
                    }, duration);
                },
                
                removeToast(id) {
                    const toast = this.toasts.find(t => t.id === id);
                    if (toast) {
                        toast.show = false;
                        setTimeout(() => {
                            const index = this.toasts.findIndex(t => t.id === id);
                            if (index > -1) {
                                this.toasts.splice(index, 1);
                            }
                        }, 300);
                    }
                },
                
                async exportData(format) {
                    if (this.selectedItems.length === 0) {
                        this.showToast('Por favor, selecciona al menos un registro para exportar', 'warning');
                        return;
                    }
                    
                    try {
                        this.showToast(`Exportando ${this.selectedItems.length} registros en formato ${format}...`, 'info');
                        
                        // Obtener datos de las evidencias seleccionadas
                        const selectedEvidences = this.records.filter(r => this.selectedItems.includes(r.id));
                        
                        if (format === 'csv') {
                            // Exportar como CSV
                            const headers = ['ID', 'Tipo', 'Título', 'Evento', 'Fecha', 'Ubicación', 'Items'];
                            const rows = selectedEvidences.map(ev => [
                                ev.id,
                                ev.type,
                                ev.title || 'Sin título',
                                ev.event,
                                ev.date,
                                ev.evidence?.location || 'Sin ubicación',
                                ev.items
                            ]);
                            
                            const csvContent = [
                                headers.join(','),
                                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                            ].join('\n');
                            
                            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `evidencias-${new Date().toISOString().split('T')[0]}.csv`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                            
                            this.showToast('Exportación CSV completada', 'success');
                        } else if (format === 'xlsx') {
                            // Para Excel, crear HTML table que Excel puede abrir
                            const htmlContent = '<html><head><meta charset="UTF-8"><style>table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #667eea; color: white; }</style></head><body><table><thead><tr><th>ID</th><th>Tipo</th><th>Título</th><th>Evento</th><th>Fecha</th><th>Ubicación</th><th>Items</th></tr></thead><tbody>' +
                                selectedEvidences.map(ev => '<tr><td>' + ev.id + '</td><td>' + ev.type + '</td><td>' + (ev.title || 'Sin título').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</td><td>' + ev.event + '</td><td>' + ev.date + '</td><td>' + (ev.evidence?.location || 'Sin ubicación').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</td><td>' + ev.items + '</td></tr>').join('') +
                                '</tbody></table></body></html>';
                            
                            const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `evidencias-${new Date().toISOString().split('T')[0]}.xls`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                            
                            this.showToast('Exportación Excel completada', 'success');
                        } else if (format === 'pdf') {
                            // Para PDF, crear HTML que se puede imprimir como PDF
                            const htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Reporte de Evidencias</title><style>body { font-family: Arial, sans-serif; padding: 20px; } h1 { color: #667eea; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #667eea; color: white; } tr:nth-child(even) { background-color: #f2f2f2; }</style></head><body><h1>Reporte de Evidencias</h1><p>Fecha de exportación: ' + new Date().toLocaleDateString('es-ES') + '</p><p>Total de registros: ' + selectedEvidences.length + '</p><table><thead><tr><th>ID</th><th>Tipo</th><th>Título</th><th>Evento</th><th>Fecha</th><th>Ubicación</th><th>Items</th></tr></thead><tbody>' +
                                selectedEvidences.map(ev => '<tr><td>' + ev.id + '</td><td>' + ev.type + '</td><td>' + (ev.title || 'Sin título').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</td><td>' + ev.event + '</td><td>' + ev.date + '</td><td>' + (ev.evidence?.location || 'Sin ubicación').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</td><td>' + ev.items + '</td></tr>').join('') +
                                '</tbody></table></body></html>';
                            
                            const blob = new Blob([htmlContent], { type: 'text/html' });
                            const url = window.URL.createObjectURL(blob);
                            const printWindow = window.open(url, '_blank');
                            printWindow.onload = () => {
                                printWindow.print();
                            };
                            
                            this.showToast('Preparando PDF para impresión...', 'info');
                        } else if (format === 'zip') {
                            // Para ZIP, descargar todos los archivos de las evidencias seleccionadas
                            this.showToast('Preparando archivos para descargar...', 'info');
                            
                            // Descargar archivos de cada evidencia
                            for (const ev of selectedEvidences) {
                                try {
                                    await this.downloadEvidence(ev.id);
                                    // Pequeño delay entre descargas
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                } catch (error) {
                                    console.error(`Error descargando evidencia ${ev.id}:`, error);
                                }
                            }
                            
                            this.showToast('Descarga de archivos iniciada', 'success');
                        }
                        
                        this.showExportModal = false;
                    } catch (error) {
                        console.error('Error exporting data:', error);
                        this.showToast('Error al exportar: ' + error.message, 'error');
                    }
                },
                
                toggleSort(field) {
                    if (this.sortBy === field) {
                        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortBy = field;
                        this.sortOrder = 'asc';
                    }
                    this.showSortModal = false;
                },
                
                get sortedRecords() {
                    let sorted = [...this.filteredRecords];
                    
                    sorted.sort((a, b) => {
                        let aVal, bVal;
                        
                        switch(this.sortBy) {
                            case 'id':
                                aVal = a.id;
                                bVal = b.id;
                                break;
                            case 'type':
                                aVal = a.type;
                                bVal = b.type;
                                break;
                            case 'date':
                                aVal = new Date(a.evidence?.created_at || a.evidence?.captured_at || 0);
                                bVal = new Date(b.evidence?.created_at || b.evidence?.captured_at || 0);
                                break;
                            case 'items':
                                aVal = a.items;
                                bVal = b.items;
                                break;
                            default:
                                aVal = a.id;
                                bVal = b.id;
                        }
                        
                        if (this.sortOrder === 'asc') {
                            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                        } else {
                            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                        }
                    });
                    
                    return sorted;
                },
                
                get paginatedRecords() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.sortedRecords.slice(start, end);
                },
                
                get totalPages() {
                    return Math.ceil(this.sortedRecords.length / this.itemsPerPage);
                },
                
                goToPage(page) {
                    if (page >= 1 && page <= this.totalPages) {
                        this.currentPage = page;
                    }
                },
                
                async downloadEvidence(evidenceId) {
                    try {
                        const response = await api.getEvidence(evidenceId);
                        if (!response.success) {
                            throw new Error(response.message || 'Error al obtener evidencia');
                        }
                        
                        const evidence = response.data;
                        if (!evidence.files || evidence.files.length === 0) {
                            this.showToast('No hay archivos disponibles para descargar', 'warning');
                            return;
                        }
                        
                        this.showToast('Preparando descarga...', 'info', 2000);
                        
                        // Descargar cada archivo usando fetch para incluir autenticación
                        for (const file of evidence.files) {
                            try {
                                const fileUrl = `${api.baseURL || 'http://localhost:3000/api'}/evidences/${evidenceId}/files/${file.id}/download`;
                                const response = await fetch(fileUrl, {
                                    headers: {
                                        'Authorization': `Bearer ${api.getToken()}`
                                    }
                                });
                                
                                if (!response.ok) {
                                    throw new Error('Error al descargar archivo');
                                }
                                
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = file.original_filename || file.file_name || `file-${file.id}`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(url);
                                
                                // Pequeño delay entre descargas
                                await new Promise(resolve => setTimeout(resolve, 300));
                            } catch (error) {
                                console.error('Error downloading file:', error);
                                this.showToast(`Error al descargar ${file.original_filename || file.file_name}: ${error.message}`, 'error');
                            }
                        }
                        
                        this.showToast('Descarga iniciada', 'success');
                    } catch (error) {
                        this.showToast('Error al descargar: ' + error.message, 'error');
                    }
                },
                
                async deleteEvidence(evidenceId) {
                    if (!confirm('¿Estás seguro de que deseas eliminar esta evidencia?')) {
                        return;
                    }
                    
                    try {
                        const response = await api.deleteEvidence(evidenceId);
                        if (response.success) {
                            this.showToast('Evidencia eliminada exitosamente', 'success');
                            await this.loadData(); // Recargar datos
                        } else {
                            throw new Error(response.message || 'Error al eliminar');
                        }
                    } catch (error) {
                        this.showToast('Error al eliminar: ' + error.message, 'error');
                    }
                },
                
                async viewEvidence(evidenceId) {
                    try {
                        const response = await api.getEvidence(evidenceId);
                        if (response.success) {
                            this.selectedEvidence = response.data;
                            this.showViewModal = true;
                        } else {
                            throw new Error(response.message || 'Error al cargar evidencia');
                        }
                    } catch (error) {
                        this.showToast('Error al cargar evidencia: ' + error.message, 'error');
                    }
                },
                
                async openEditModal(evidenceId) {
                    try {
                        const response = await api.getEvidence(evidenceId);
                        if (response.success) {
                            this.selectedEvidence = response.data;
                            this.editFormData = {
                                title: response.data.title || '',
                                description: response.data.description || '',
                                location: response.data.location || '',
                                tags: Array.isArray(response.data.tags) ? [...response.data.tags] : []
                            };
                            this.newFiles = [];
                            this.filesToDelete = [];
                            this.showEditModal = true;
                        } else {
                            throw new Error(response.message || 'Error al cargar evidencia');
                        }
                    } catch (error) {
                        this.showToast('Error al cargar evidencia: ' + error.message, 'error');
                    }
                },
                
                async saveEvidence() {
                    if (!this.selectedEvidence) return;
                    
                    try {
                        this.saving = true;
                        
                        // Delete files marked for deletion
                        for (const fileId of this.filesToDelete) {
                            try {
                                await api.deleteEvidenceFile(this.selectedEvidence.id, fileId);
                            } catch (error) {
                                console.error('Error deleting file:', error);
                            }
                        }
                        
                        const evidenceData = {
                            title: this.editFormData.title.trim(),
                            description: this.editFormData.description || '',
                            location: this.editFormData.location || '',
                            tags: this.editFormData.tags
                        };
                        
                        // Update evidence with new files if any
                        const response = await api.updateEvidence(
                            this.selectedEvidence.id, 
                            evidenceData,
                            this.newFiles.map(f => f.file)
                        );
                        
                        if (response.success) {
                            this.showToast('Evidencia actualizada exitosamente', 'success');
                            this.showEditModal = false;
                            this.newFiles = [];
                            this.filesToDelete = [];
                            await this.loadData();
                        } else {
                            throw new Error(response.message || 'Error al actualizar');
                        }
                    } catch (error) {
                        this.showToast('Error al actualizar: ' + error.message, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                
                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        this.newFiles.push({
                            id: Date.now() + Math.random(),
                            file: file,
                            name: file.name,
                            size: file.size,
                            preview: file.type.startsWith('image/') ? URL.createObjectURL(file) : null
                        });
                    });
                },
                
                removeNewFile(fileId) {
                    const index = this.newFiles.findIndex(f => f.id === fileId);
                    if (index > -1) {
                        if (this.newFiles[index].preview) {
                            URL.revokeObjectURL(this.newFiles[index].preview);
                        }
                        this.newFiles.splice(index, 1);
                    }
                },
                
                markFileForDeletion(fileId) {
                    if (!this.filesToDelete.includes(fileId)) {
                        this.filesToDelete.push(fileId);
                    }
                },
                
                unmarkFileForDeletion(fileId) {
                    const index = this.filesToDelete.indexOf(fileId);
                    if (index > -1) {
                        this.filesToDelete.splice(index, 1);
                    }
                },
                
                isFileMarkedForDeletion(fileId) {
                    return this.filesToDelete.includes(fileId);
                },
                
                async shareEvidence(evidenceId) {
                    try {
                        const record = this.records.find(r => r.id === evidenceId);
                        if (!record) {
                            this.showToast('Evidencia no encontrada', 'error');
                            return;
                        }
                        
                        this.selectedEvidence = record.evidence;
                        // Generar enlace compartible (podría ser un enlace único del backend)
                        const baseUrl = window.location.origin;
                        this.shareLink = `${baseUrl}/listados.html#evidence-${evidenceId}`;
                        this.showShareModal = true;
                    } catch (error) {
                        this.showToast('Error al compartir: ' + error.message, 'error');
                    }
                },
                
                copyShareLink() {
                    if (!this.shareLink) return;
                    
                    navigator.clipboard.writeText(this.shareLink).then(() => {
                        this.showToast('Enlace copiado al portapapeles', 'success');
                    }).catch(() => {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = this.shareLink;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showToast('Enlace copiado al portapapeles', 'success');
                    });
                },
                
                async downloadFile(evidenceId, fileId, filename) {
                    try {
                        const fileUrl = `${api.baseURL || 'http://localhost:3000/api'}/evidences/${evidenceId}/files/${fileId}/download`;
                        const response = await fetch(fileUrl, {
                            headers: {
                                'Authorization': `Bearer ${api.getToken()}`
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Error al descargar archivo');
                        }
                        
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename || `file-${fileId}`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        
                        this.showToast('Archivo descargado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error downloading file:', error);
                        this.showToast('Error al descargar archivo: ' + error.message, 'error');
                    }
                },
                
                addTag() {
                    const tagInput = document.getElementById('tagInput');
                    if (tagInput && tagInput.value.trim()) {
                        const tag = tagInput.value.trim();
                        if (!this.editFormData.tags.includes(tag)) {
                            this.editFormData.tags.push(tag);
                        }
                        tagInput.value = '';
                    }
                },
                
                removeTag(tag) {
                    const index = this.editFormData.tags.indexOf(tag);
                    if (index > -1) {
                        this.editFormData.tags.splice(index, 1);
                    }
                }
            };
        }
    </script>
</head>
<body class="bg-gray-50" x-data="listadosData()">

    <!-- Mobile Overlay -->
    <div x-show="sidebarOpen" 
         @click="sidebarOpen = false"
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"></div>

    <!-- Sidebar -->
    <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'" 
            class="fixed left-0 top-0 h-full bg-white shadow-xl transition-all duration-300 z-50 w-64 lg:w-64">
        <div class="flex flex-col h-full">
            <div class="p-4 lg:p-6 gradient-bg">
                <div class="flex items-center justify-between">
                    <div class="text-white">
                        <h1 class="text-lg lg:text-xl font-bold">SuperVision</h1>
                        <p class="text-xs text-purple-200">Sistema de Monitoreo</p>
                    </div>
                    <button @click="sidebarOpen = !sidebarOpen" class="text-white hover:bg-white/20 p-2 rounded-lg lg:hidden">
                        <i class="fas fa-times"></i>
                    </button>
                    <button @click="sidebarOpen = !sidebarOpen" class="text-white hover:bg-white/20 p-2 rounded-lg hidden lg:block">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>

            <nav class="flex-1 p-2 lg:p-4 space-y-1 lg:space-y-2 overflow-y-auto">
                <a href="index.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-chart-line w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Dashboard</span>
                </a>

                <a href="registro-evidencias.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-camera w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Registro de Evidencias</span>
                </a>

                <a href="listados.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 text-white">
                    <i class="fas fa-list-alt w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Listados y Registros</span>
                </a>

                <a href="supervision-tiempo-real.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-eye w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Supervisión en Vivo</span>
                </a>

                <a href="eventos-capacitacion.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-calendar-check w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Eventos y Capacitación</span>
                </a>

                <hr class="my-2 lg:my-4">

                <a href="configuracion.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-cog w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Configuración</span>
                </a>

                <a href="ayuda.html" class="flex items-center space-x-3 p-2 lg:p-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                    <i class="fas fa-question-circle w-5 lg:w-6"></i>
                    <span class="font-medium text-sm lg:text-base">Ayuda</span>
                </a>
            </nav>

            <div class="p-3 lg:p-4 border-t">
                <div class="flex items-center space-x-2 lg:space-x-3 mb-3">
                    <img :src="userProfile ? `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfile.full_name || 'User')}&background=667eea&color=fff` : 'https://ui-avatars.com/api/?name=User&background=667eea&color=fff'"
                         class="w-8 h-8 lg:w-10 lg:h-10 rounded-full flex-shrink-0" alt="User">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs lg:text-sm font-semibold text-gray-700 truncate" x-text="userProfile ? userProfile.full_name : 'Usuario'"></p>
                        <p class="text-[10px] lg:text-xs text-gray-500 truncate" x-text="userProfile ? (userProfile.role || 'Usuario').charAt(0).toUpperCase() + (userProfile.role || 'Usuario').slice(1) : 'Usuario'"></p>
                    </div>
                </div>
                <button @click="api.logout()" class="w-full flex items-center justify-center space-x-2 px-3 lg:px-4 py-2 lg:py-2.5 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl font-medium transition-colors text-sm lg:text-base">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-64 transition-all duration-300">

        <!-- Top Bar -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between p-4 lg:p-6 gap-4">
                <div class="flex items-center justify-between w-full lg:w-auto">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <button @click="sidebarOpen = true" class="lg:hidden text-gray-600 hover:bg-gray-100 p-2 rounded-lg">
                                <i class="fas fa-bars text-xl"></i>
                            </button>
                            <div>
                                <h2 class="text-xl lg:text-2xl font-bold text-gray-800">Listados y Registros Entregables</h2>
                                <p class="text-gray-500 text-xs lg:text-sm hidden sm:block">Gestiona y exporta todos tus registros y documentos</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </header>


        <!-- Main Content -->
        <main class="p-4 lg:p-6">

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium mb-1">Total Registros</p>
                            <p class="text-3xl font-bold text-gray-800" x-text="stats.total"></p>
                        </div>
                        <div class="p-4 bg-blue-100 rounded-xl">
                            <i class="fas fa-database text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium mb-1">Fotos</p>
                            <p class="text-3xl font-bold text-gray-800" x-text="stats.photos"></p>
                        </div>
                        <div class="p-4 bg-purple-100 rounded-xl">
                            <i class="fas fa-image text-purple-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium mb-1">Videos</p>
                            <p class="text-3xl font-bold text-gray-800" x-text="stats.videos"></p>
                        </div>
                        <div class="p-4 bg-green-100 rounded-xl">
                            <i class="fas fa-video text-green-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium mb-1">Asistentes</p>
                            <p class="text-3xl font-bold text-gray-800" x-text="stats.attendance"></p>
                        </div>
                        <div class="p-4 bg-orange-100 rounded-xl">
                            <i class="fas fa-users text-orange-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Actions -->
            <div class="bg-white rounded-2xl shadow-lg p-4 lg:p-6 mb-4 lg:mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

                    <!-- Filter Tabs -->
                    <div class="flex flex-wrap gap-2">
                        <button @click="activeTab = 'all'"
                                :class="activeTab === 'all' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-3 lg:px-4 py-2 rounded-xl font-medium transition-all text-sm">
                            <i class="fas fa-globe mr-1 lg:mr-2"></i>Todos
                        </button>
                        <button @click="activeTab = 'photos'"
                                :class="activeTab === 'photos' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-xl font-medium transition-all">
                            <i class="fas fa-camera mr-2"></i>Fotografías
                        </button>
                        <button @click="activeTab = 'videos'"
                                :class="activeTab === 'videos' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-xl font-medium transition-all">
                            <i class="fas fa-video mr-2"></i>Videos
                        </button>
                        <button @click="activeTab = 'attendance'"
                                :class="activeTab === 'attendance' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-xl font-medium transition-all">
                            <i class="fas fa-clipboard-list mr-2"></i>Asistencia
                        </button>
                        <button @click="activeTab = 'inventory'"
                                :class="activeTab === 'inventory' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-xl font-medium transition-all">
                            <i class="fas fa-box mr-2"></i>Bienes
                        </button>
                        <button @click="activeTab = 'evaluations'"
                                :class="activeTab === 'evaluations' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-xl font-medium transition-all">
                            <i class="fas fa-clipboard-check mr-2"></i>Evaluaciones
                        </button>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center gap-3">
                        <button @click="showExportModal = true"
                                :disabled="selectedItems.length === 0"
                                :class="selectedItems.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg'"
                                class="px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-medium transition-all">
                            <i class="fas fa-file-export mr-2"></i>
                            Exportar <span x-show="selectedItems.length > 0" x-text="`(${selectedItems.length})`"></span>
                        </button>
                        <button @click="showFilterModal = !showFilterModal" 
                                :class="activeTab !== 'all' || searchQuery ? 'bg-purple-100 text-purple-700 border-purple-300' : ''"
                                class="px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all relative">
                            <i class="fas fa-filter"></i>
                            <span x-show="activeTab !== 'all' || searchQuery" 
                                  class="absolute -top-1 -right-1 w-3 h-3 bg-purple-600 rounded-full"></span>
                        </button>
                        <button @click="showSortModal = !showSortModal" 
                                class="px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all">
                            <i class="fas fa-sort"></i>
                            <span class="ml-1 text-xs" x-text="sortOrder === 'asc' ? '↑' : '↓'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">

                <!-- Table Header -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-800">
                            Registros <span class="text-purple-600" x-text="`(${sortedRecords.length})`"></span>
                        </h3>
                        <button @click="selectAll()" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                            <i class="fas fa-check-square mr-1"></i>
                            <span x-text="selectedItems.length === sortedRecords.length ? 'Deseleccionar todos' : 'Seleccionar todos'"></span>
                        </button>
                    </div>
                </div>

                <!-- Table Content -->
                <div x-show="loading" class="text-center py-16">
                    <i class="fas fa-spinner fa-spin text-purple-600 text-4xl mb-4"></i>
                    <p class="text-gray-600 font-semibold mb-2">Cargando registros...</p>
                </div>
                <div x-show="!loading" class="overflow-x-auto">
                    <table class="w-full" x-show="sortedRecords.length > 0">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left">
                                    <input type="checkbox"
                                           @change="selectAll()"
                                           :checked="selectedItems.length === sortedRecords.length && sortedRecords.length > 0"
                                           class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
                                </th>
                                <th @click="toggleSort('id')" class="px-6 py-4 text-left text-sm font-semibold text-gray-600 cursor-pointer hover:bg-gray-100">
                                    ID
                                    <i x-show="sortBy === 'id'" :class="sortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'" class="fas ml-1"></i>
                                </th>
                                <th @click="toggleSort('type')" class="px-6 py-4 text-left text-sm font-semibold text-gray-600 cursor-pointer hover:bg-gray-100">
                                    Tipo de Registro
                                    <i x-show="sortBy === 'type'" :class="sortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'" class="fas ml-1"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">Evento Asociado</th>
                                <th @click="toggleSort('items')" class="px-6 py-4 text-left text-sm font-semibold text-gray-600 cursor-pointer hover:bg-gray-100">
                                    Items
                                    <i x-show="sortBy === 'items'" :class="sortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'" class="fas ml-1"></i>
                                </th>
                                <th @click="toggleSort('date')" class="px-6 py-4 text-left text-sm font-semibold text-gray-600 cursor-pointer hover:bg-gray-100">
                                    Fecha
                                    <i x-show="sortBy === 'date'" :class="sortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'" class="fas ml-1"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">Estado</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="record in paginatedRecords" :key="record.id">
                                <tr class="table-row-hover cursor-pointer">
                                    <td class="px-3 lg:px-6 py-3 lg:py-4">
                                        <input type="checkbox"
                                               @change="toggleSelection(record.id)"
                                               :checked="selectedItems.includes(record.id)"
                                               class="w-4 h-4 lg:w-5 lg:h-5 text-purple-600 rounded focus:ring-purple-500">
                                    </td>
                                    <td class="px-3 lg:px-6 py-3 lg:py-4 text-xs lg:text-sm font-semibold text-gray-700" x-text="`#${record.id}`"></td>
                                    <td class="px-3 lg:px-6 py-3 lg:py-4">
                                        <div class="flex items-center space-x-2 lg:space-x-3">
                                            <div class="w-8 h-8 lg:w-10 lg:h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                                                 :class="{
                                                     'bg-blue-100': record.category === 'photos',
                                                     'bg-purple-100': record.category === 'videos',
                                                     'bg-green-100': record.category === 'attendance',
                                                     'bg-orange-100': record.category === 'inventory',
                                                     'bg-pink-100': record.category === 'evaluations'
                                                 }">
                                                <i class="text-base lg:text-xl"
                                                   :class="{
                                                       'fas fa-camera text-blue-600': record.category === 'photos',
                                                       'fas fa-video text-purple-600': record.category === 'videos',
                                                       'fas fa-clipboard-list text-green-600': record.category === 'attendance',
                                                       'fas fa-box text-orange-600': record.category === 'inventory',
                                                       'fas fa-clipboard-check text-pink-600': record.category === 'evaluations'
                                                   }"></i>
                                            </div>
                                            <span class="text-xs lg:text-sm font-medium text-gray-800 truncate" x-text="record.type"></span>
                                        </div>
                                    </td>
                                    <td class="px-3 lg:px-6 py-3 lg:py-4 text-xs lg:text-sm text-gray-600 truncate max-w-[120px] lg:max-w-none" x-text="record.event"></td>
                                    <td class="px-3 lg:px-6 py-3 lg:py-4">
                                        <span class="px-2 lg:px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs lg:text-sm font-medium" x-text="record.items"></span>
                                    </td>
                                    <td class="px-3 lg:px-6 py-3 lg:py-4 text-xs lg:text-sm text-gray-600" x-text="record.date"></td>
                                    <td class="px-3 lg:px-6 py-3 lg:py-4">
                                        <span class="px-2 lg:px-3 py-1 rounded-full text-[10px] lg:text-xs font-medium"
                                              :class="{
                                                  'bg-green-100 text-green-700': record.status === 'Completo',
                                                  'bg-yellow-100 text-yellow-700': record.status === 'Procesando',
                                                  'bg-red-100 text-red-700': record.status === 'Pendiente'
                                              }"
                                              x-text="record.status"></span>
                                    </td>
                                    <td class="px-3 lg:px-6 py-3 lg:py-4">
                                        <div class="flex items-center space-x-1 lg:space-x-2 flex-wrap">
                                            <button @click="viewEvidence(record.id)" class="p-1.5 lg:p-2 hover:bg-purple-50 text-purple-600 rounded-lg transition-colors text-sm lg:text-base" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button @click="openEditModal(record.id)" class="p-1.5 lg:p-2 hover:bg-green-50 text-green-600 rounded-lg transition-colors text-sm lg:text-base" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="shareEvidence(record.id)" class="p-1.5 lg:p-2 hover:bg-blue-50 text-blue-600 rounded-lg transition-colors text-sm lg:text-base" title="Compartir">
                                                <i class="fas fa-share-alt"></i>
                                            </button>
                                            <button @click="downloadEvidence(record.id)" class="p-1.5 lg:p-2 hover:bg-orange-50 text-orange-600 rounded-lg transition-colors text-sm lg:text-base" title="Descargar">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button @click="deleteEvidence(record.id)" class="p-1.5 lg:p-2 hover:bg-red-50 text-red-600 rounded-lg transition-colors text-sm lg:text-base" title="Eliminar">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <!-- Empty State -->
                    <div x-show="!loading && sortedRecords.length === 0" class="text-center py-16">
                        <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
                        <p class="text-xl font-semibold text-gray-600 mb-2">No se encontraron registros</p>
                        <p class="text-sm text-gray-500">Intenta con otros filtros o criterios de búsqueda</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="p-6 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-gray-600">
                            Mostrando <span class="font-semibold" x-text="paginatedRecords.length"></span> de <span class="font-semibold" x-text="sortedRecords.length"></span> registros
                            <span x-show="totalPages > 1"> - Página <span class="font-semibold" x-text="currentPage"></span> de <span class="font-semibold" x-text="totalPages"></span></span>
                        </p>
                        <div class="flex items-center space-x-2" x-show="totalPages > 1">
                            <button @click="goToPage(currentPage - 1)" 
                                    :disabled="currentPage === 1"
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <template x-for="page in Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                                if (totalPages <= 5) return i + 1;
                                if (currentPage <= 3) return i + 1;
                                if (currentPage >= totalPages - 2) return totalPages - 4 + i;
                                return currentPage - 2 + i;
                            })" :key="page">
                                <button @click="goToPage(page)" 
                                        :class="page === currentPage ? 'bg-purple-600 text-white' : 'border border-gray-300 hover:bg-gray-50'"
                                        class="px-4 py-2 rounded-lg font-medium transition-colors" 
                                        x-text="page"></button>
                            </template>
                            <button @click="goToPage(currentPage + 1)" 
                                    :disabled="currentPage === totalPages"
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>

        </main>

    </div>

    <!-- Export Modal -->
    <div x-show="showExportModal"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="showExportModal = false">

        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-4 lg:p-8"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-90"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-90">

            <div class="text-center mb-4 lg:mb-6">
                <div class="w-12 h-12 lg:w-16 lg:h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 lg:mb-4">
                    <i class="fas fa-file-export text-green-600 text-xl lg:text-2xl"></i>
                </div>
                <h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Exportar Registros</h3>
                <p class="text-gray-600 text-sm lg:text-base">Selecciona el formato de exportación</p>
            </div>

            <div class="space-y-2 lg:space-y-3 mb-4 lg:mb-6">
                <button @click="exportData('xlsx')" class="w-full p-3 lg:p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all text-left flex items-center space-x-3 lg:space-x-4">
                    <div class="w-10 h-10 lg:w-12 lg:h-12 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-file-excel text-green-600 text-lg lg:text-xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 text-sm lg:text-base">Excel (.xlsx)</p>
                        <p class="text-xs lg:text-sm text-gray-500">Archivo de hojas de cálculo</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 flex-shrink-0"></i>
                </button>

                <button @click="exportData('pdf')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition-all text-left flex items-center space-x-4">
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-pdf text-red-600 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">PDF (.pdf)</p>
                        <p class="text-sm text-gray-500">Documento portable</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>

                <button @click="exportData('csv')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all text-left flex items-center space-x-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-csv text-blue-600 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">CSV (.csv)</p>
                        <p class="text-sm text-gray-500">Valores separados por comas</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>

                <button @click="exportData('zip')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all text-left flex items-center space-x-4">
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-archive text-purple-600 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">ZIP (.zip)</p>
                        <p class="text-sm text-gray-500">Archivo comprimido con medios</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>
            </div>

            <button @click="showExportModal = false" class="w-full py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-all text-sm">
                Cancelar
            </button>
        </div>
    </div>
</div>

    <!-- View Evidence Modal -->
    <div x-show="showViewModal"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 modal-backdrop z-[9999] flex items-center justify-center p-4"
         @click.self="showViewModal = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
             x-show="selectedEvidence">
            <div class="p-4 lg:p-6 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-t-2xl">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-xl lg:text-2xl font-bold">Detalles de Evidencia</h3>
                        <p class="text-purple-100 text-xs lg:text-sm mt-1 truncate" x-text="selectedEvidence?.title || 'Sin título'"></p>
                    </div>
                    <button @click="showViewModal = false" class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors flex-shrink-0">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 lg:p-8 space-y-4 lg:space-y-6" x-show="selectedEvidence">
                <template x-if="selectedEvidence">
                    <div>
                        <!-- Información Principal -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 lg:gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Título</label>
                                <p class="text-gray-800" x-text="selectedEvidence?.title || 'Sin título'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo</label>
                                <p class="text-gray-800" x-text="selectedEvidence?.evidence_type ? getEvidenceTypeLabel(selectedEvidence.evidence_type) : 'Sin tipo'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Evento Asociado</label>
                                <p class="text-gray-800" x-text="selectedEvidence?.event_id ? 'Evento #' + selectedEvidence.event_id : 'Sin evento'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ubicación</label>
                                <p class="text-gray-800" x-text="selectedEvidence?.location || 'Sin ubicación'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Creación</label>
                                <p class="text-gray-800" x-text="formatDate(selectedEvidence?.created_at || selectedEvidence?.captured_at)"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Registrado por</label>
                                <p class="text-gray-800" x-text="selectedEvidence?.uploaded_by_name || 'Sistema'"></p>
                            </div>
                        </div>

                        <!-- Descripción -->
                        <div x-show="selectedEvidence?.description">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Descripción</label>
                            <p class="text-gray-800 whitespace-pre-wrap" x-text="selectedEvidence?.description || ''"></p>
                        </div>

                        <!-- Tags -->
                        <div x-show="selectedEvidence?.tags && Array.isArray(selectedEvidence.tags) && selectedEvidence.tags.length > 0">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Etiquetas</label>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="tag in selectedEvidence.tags" :key="tag">
                                    <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium" x-text="tag"></span>
                                </template>
                            </div>
                        </div>

                        <!-- Archivos -->
                        <div x-show="selectedEvidence?.files && Array.isArray(selectedEvidence.files) && selectedEvidence.files.length > 0">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Archivos (<span x-text="selectedEvidence.files.length"></span>)</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <template x-for="file in selectedEvidence.files" :key="file.id">
                                    <div class="p-4 border border-gray-200 rounded-xl hover:border-purple-300 transition-colors">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-file text-purple-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-semibold text-gray-800 truncate" x-text="file.original_filename || file.file_name || 'Archivo'"></p>
                                                <p class="text-xs text-gray-500" x-text="file.file_size ? (file.file_size / 1024).toFixed(2) + ' KB' : 'Tamaño desconocido'"></p>
                                            </div>
                                            <button @click="downloadFile(selectedEvidence.id, file.id, file.original_filename || file.file_name)"
                                                    class="p-2 hover:bg-purple-50 text-purple-600 rounded-lg transition-colors" 
                                                    title="Descargar">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div x-show="!selectedEvidence?.files || !Array.isArray(selectedEvidence.files) || selectedEvidence.files.length === 0" class="p-4 bg-gray-50 rounded-xl text-center">
                            <i class="fas fa-file-slash text-gray-300 text-3xl mb-2"></i>
                            <p class="text-sm text-gray-500">No hay archivos asociados</p>
                        </div>
                    </div>
                </template>

                <!-- Acciones -->
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 pt-4 border-t border-gray-200" x-show="selectedEvidence">
                    <button @click="showViewModal = false; openEditModal(selectedEvidence?.id)" 
                            class="flex-1 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors text-sm">
                        <i class="fas fa-edit mr-2"></i>Editar
                    </button>
                    <button @click="showViewModal = false; shareEvidence(selectedEvidence?.id)" 
                            class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors text-sm">
                        <i class="fas fa-share-alt mr-2"></i>Compartir
                    </button>
                    <button @click="downloadEvidence(selectedEvidence?.id)" 
                            class="flex-1 py-3 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 transition-colors text-sm">
                        <i class="fas fa-download mr-2"></i>Descargar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Evidence Modal -->
    <div x-show="showEditModal"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 modal-backdrop z-[9999] flex items-center justify-center p-4"
         @click.self="showEditModal = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-4 lg:p-6 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-t-2xl">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-xl lg:text-2xl font-bold">Editar Evidencia</h3>
                        <p class="text-green-100 text-xs lg:text-sm mt-1">Modifica los detalles de la evidencia</p>
                    </div>
                    <button @click="showEditModal = false" class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors flex-shrink-0">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 lg:p-8 space-y-4 lg:space-y-6">
                <form @submit.prevent="saveEvidence()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Título *</label>
                        <input type="text" x-model="editFormData.title" placeholder="Título de la evidencia" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Descripción</label>
                        <textarea rows="4" x-model="editFormData.description" placeholder="Descripción de la evidencia"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Ubicación</label>
                        <input type="text" x-model="editFormData.location" placeholder="Ubicación donde se registró"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Etiquetas</label>
                        <div class="flex items-center space-x-2 mb-2">
                            <input type="text" id="tagInput" placeholder="Agregar etiqueta" 
                                   @keydown.enter.prevent="addTag()"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <button type="button" @click="addTag()" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="flex flex-wrap gap-2" x-show="editFormData.tags.length > 0">
                            <template x-for="tag in editFormData.tags" :key="tag">
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium flex items-center space-x-2">
                                    <span x-text="tag"></span>
                                    <button type="button" @click="removeTag(tag)" class="text-green-700 hover:text-green-900">
                                        <i class="fas fa-times text-xs"></i>
                                    </button>
                                </span>
                            </template>
                        </div>
                    </div>

                    <!-- Archivos existentes -->
                    <div x-show="selectedEvidence && selectedEvidence.files && Array.isArray(selectedEvidence.files) && selectedEvidence.files.length > 0">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Archivos Existentes</label>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            <template x-for="file in (selectedEvidence?.files || [])" :key="file.id">
                                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                                     :class="isFileMarkedForDeletion(file.id) ? 'bg-red-50 border-red-300' : 'bg-gray-50'">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        <i class="fas fa-file text-gray-500"></i>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-800 truncate" x-text="file.original_filename || file.file_name || 'Archivo'"></p>
                                            <p class="text-xs text-gray-500" x-text="file.file_size ? (file.file_size / 1024).toFixed(2) + ' KB' : ''"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button type="button" 
                                                @click="isFileMarkedForDeletion(file.id) ? unmarkFileForDeletion(file.id) : markFileForDeletion(file.id)"
                                                :class="isFileMarkedForDeletion(file.id) ? 'text-green-600 hover:text-green-700' : 'text-red-600 hover:text-red-700'"
                                                class="p-2 transition-colors" 
                                                :title="isFileMarkedForDeletion(file.id) ? 'Restaurar archivo' : 'Eliminar archivo'">
                                            <i :class="isFileMarkedForDeletion(file.id) ? 'fa-undo' : 'fa-trash'" class="fas"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Subir nuevos archivos -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Agregar Nuevos Archivos</label>
                        <input type="file" 
                               @change="handleFileSelect($event)"
                               multiple
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Puedes seleccionar múltiples archivos
                        </p>
                        
                        <!-- Preview de nuevos archivos -->
                        <div class="mt-4 space-y-2" x-show="newFiles.length > 0">
                            <template x-for="newFile in newFiles" :key="newFile.id">
                                <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        <i class="fas fa-file text-blue-500"></i>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-800 truncate" x-text="newFile.name"></p>
                                            <p class="text-xs text-gray-500" x-text="(newFile.size / 1024).toFixed(2) + ' KB'"></p>
                                        </div>
                                    </div>
                                    <button type="button" 
                                            @click="removeNewFile(newFile.id)"
                                            class="p-2 text-red-600 hover:text-red-700 transition-colors" 
                                            title="Eliminar">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 pt-4">
                        <button type="submit" 
                                :disabled="saving"
                                :class="saving ? 'opacity-50 cursor-not-allowed' : ''"
                                class="flex-1 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors text-sm">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="saving ? 'Guardando...' : 'Guardar Cambios'"></span>
                        </button>
                        <button type="button" 
                                @click="showEditModal = false; newFiles = []; filesToDelete = [];" 
                                :disabled="saving"
                                class="flex-1 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors text-sm">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Share Evidence Modal -->
    <div x-show="showShareModal"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 modal-backdrop z-[9999] flex items-center justify-center p-4"
         @click.self="showShareModal = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4">
            <div class="p-4 lg:p-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-t-2xl">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-xl lg:text-2xl font-bold">Compartir Evidencia</h3>
                        <p class="text-blue-100 text-xs lg:text-sm mt-1 truncate" x-text="selectedEvidence?.title || 'Sin título'"></p>
                    </div>
                    <button @click="showShareModal = false" class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors flex-shrink-0">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 lg:p-8 space-y-4 lg:space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Enlace para compartir</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" x-model="shareLink" readonly
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button @click="copyShareLink()" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors">
                            <i class="fas fa-copy mr-2"></i>Copiar
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Comparte este enlace para que otros puedan ver esta evidencia
                    </p>
                </div>

                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 pt-4 border-t border-gray-200">
                    <button @click="copyShareLink()" 
                            class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors text-sm">
                        <i class="fas fa-copy mr-2"></i>Copiar Enlace
                    </button>
                    <button @click="showShareModal = false" 
                            class="flex-1 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors text-sm">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="fixed top-16 lg:top-20 right-2 lg:right-6 z-[9999] space-y-3" style="max-width: calc(100vw - 1rem); width: 100%; max-width: 400px;" x-show="toasts && Array.isArray(toasts) && toasts.length > 0">
        <template x-for="(toast, index) in (toasts || [])" :key="toast?.id || index">
            <div x-show="toast && toast.show"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-full"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-x-0"
                 x-transition:leave-end="opacity-0 transform translate-x-full"
                 class="bg-white rounded-lg shadow-2xl border-l-4 p-3 lg:p-4 flex items-start space-x-2 lg:space-x-3 w-full"
                 :class="{
                     'border-green-500': toast?.type === 'success',
                     'border-red-500': toast?.type === 'error',
                     'border-yellow-500': toast?.type === 'warning',
                     'border-blue-500': toast?.type === 'info'
                 }">
                <div class="flex-shrink-0">
                    <i class="fas text-xl"
                       :class="{
                           'fa-check-circle text-green-500': toast?.type === 'success',
                           'fa-exclamation-circle text-red-500': toast?.type === 'error',
                           'fa-exclamation-triangle text-yellow-500': toast?.type === 'warning',
                           'fa-info-circle text-blue-500': toast?.type === 'info'
                       }"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-gray-800 break-words" x-text="toast?.message || ''"></p>
                </div>
                <button @click="removeToast(toast?.id)" class="flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </template>
    </div>

</body>
</html>
